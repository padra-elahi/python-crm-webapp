{% extends "base.html" %}
{% block content %}

{% if user.role == "boss" %}
<nav class="mb-6 flex space-x-4 rtl:space-x-reverse">
    <a href="/customers" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-semibold">Ù…Ø´ØªØ±ÛŒØ§Ù†</a>
</nav>
{% endif %}

<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
    <div class="bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-xl font-semibold text-gray-700 mb-4">Ø®Ù„Ø§ØµÙ‡ ÙˆØ¸ÛŒÙÙ‡ Ù‡Ø§</h2>
        <p class="text-lg text-gray-600">
            Ø´Ù…Ø§ {{ total_tasks }} ÙˆØ¸ÛŒÙÙ‡ Ø¯Ø§Ø±ÛŒØ¯.
        </p>
        <p class="text-lg text-gray-600 mt-2">
            Ø§Ø² Ø§ÛŒÙ† ØªØ¹Ø¯Ø§Ø¯ØŒ {{ completed_tasks_count }} ÙˆØ¸ÛŒÙÙ‡ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡ Ø§Ø³Øª.
        </p>
    </div>
</div>

{% if notifications %}
<div id="notifications" class="mb-6">
    <h2 class="text-xl font-bold text-yellow-800 mb-3">ğŸ”” Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒâ€ŒÙ‡Ø§ÛŒ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ</h2>
    <div class="space-y-2">
    {% for notif in notifications %}
        <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 flex justify-between items-center rounded-r-lg">
            <div>
                <p class="font-bold">ÙˆØ¸ÛŒÙÙ‡: <a href="/task/{{ notif.task_id }}" class="underline">{{ notif.task.title }}</a></p>
                <p>{{ notif.message }}</p>
            </div>
            <form action="/notifications/mark-read/{{ notif.id }}" method="post">
                <button type="submit" class="text-xs bg-white text-gray-700 px-2 py-1 rounded border">Ø®ÙˆØ§Ù†Ø¯Ù‡ Ø´Ø¯</button>
            </form>
        </div>
    {% endfor %}
    </div>
</div>
{% endif %}

<div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
    <div class="lg:col-span-1 space-y-6">
        <form id="create-task-form" method="post" action="/task/create" class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-xl font-bold mb-4 text-gray-800">Ø§ÛŒØ¬Ø§Ø¯ ÙˆØ¸ÛŒÙÙ‡ Ø¬Ø¯ÛŒØ¯</h3>
            <div class="space-y-4">
                <input name="title" placeholder="Ø¹Ù†ÙˆØ§Ù† ÙˆØ¸ÛŒÙÙ‡" class="w-full p-2 border rounded-md" required />
                <textarea name="description" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª ÙˆØ¸ÛŒÙÙ‡" rows="3" class="w-full p-2 border rounded-md" required></textarea>
                <div>
                    <label class="text-sm">Ù¾Ø±ÙˆÚ˜Ù‡ Ù…Ø±ØªØ¨Ø·:</label>
                    <select name="project_id" id="project-selector-create" class="w-full">
                        <option value="">Ù‡ÛŒÚ†Ú©Ø¯Ø§Ù…</option>
                        {% for p in projects %}
                        <option value="{{ p.id }}">{{ p.internal_number }} - {{ p.description | truncate(50) }}</option>
                        {% endfor %}
                    </select>
                </div>
                <select name="task_type" class="w-full p-2 border rounded-md bg-white"><option value="" disabled selected>Ù†ÙˆØ¹ ÙˆØ¸ÛŒÙÙ‡</option>{% for type in TASK_TYPES %}<option value="{{ type }}">{{ type }}</option>{% endfor %}</select>
                <select name="level" class="w-full p-2 border rounded-md bg-white"><option value="" disabled selected>Ø³Ø·Ø­ Ø§Ù‡Ù…ÛŒØª</option>{% for level in TASK_LEVELS %}<option value="{{ level }}">{{ level }}</option>{% endfor %}</select>
                <div><label class="text-sm">Ø¨Ø®Ø´:</label><select id="section-selector" class="w-full p-2 border rounded-md bg-white"><option value="all" selected>Ù‡Ù…Ù‡ Ø¨Ø®Ø´ Ù‡Ø§</option>{% for section in SECTIONS %}<option value="{{ section }}">{{ section }}</option>{% endfor %}</select></div>
                <div><label class="text-sm">Ù…Ø³Ø¦ÙˆÙ„ Ø§Ù†Ø¬Ø§Ù…:</label><select id="user-selector" name="assigned_to" class="w-full p-2 border rounded-md bg-white" required><option>Ø§Ø¨ØªØ¯Ø§ Ø¨Ø®Ø´ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option></select></div>
                <div><label class="text-sm">Ø±Ù‡Ø¨Ø± ÙˆØ¸ÛŒÙÙ‡ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ):</label><select id="leader-selector" name="leader_id" class="w-full p-2 border rounded-md bg-white"><option value="">Ù‡ÛŒÚ†Ú©Ø¯Ø§Ù…</option></select></div>
                <div><label class="text-sm">ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹:</label><input name="start_date" type="date" class="w-full p-2 border rounded-md" required></div>
                <div><label class="text-sm">ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù†:</label><input name="end_date" type="date" class="w-full p-2 border rounded-md" required></div>
                <div><label class="text-sm">ØªØ§Ø±ÛŒØ® Ù¾ÛŒÚ¯ÛŒØ±ÛŒ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ):</label><input type="date" name="follow_up_date" class="w-full p-2 border rounded-md"></div>
                <div><label class="text-sm">Ù¾ÛŒØ§Ù… Ù¾ÛŒÚ¯ÛŒØ±ÛŒ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ):</label><input type="text" name="follow_up_message" placeholder="Ù…ØªÙ† ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ Ø´Ù…Ø§..." class="w-full p-2 border rounded-md"></div>
                <button class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition">Ø§ÛŒØ¬Ø§Ø¯ ÙˆØ¸ÛŒÙÙ‡</button>
            </div>
        </form>
        <form id="filter-form" method="get" action="/dashboard" class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-xl font-bold mb-4 text-gray-800">ÙÛŒÙ„ØªØ± ÙˆØ¸Ø§ÛŒÙ</h3>
            <div class="space-y-4">
                <input type="text" name="search_filter" placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¹Ù†ÙˆØ§Ù† ÙˆØ¸ÛŒÙÙ‡..." value="{{ filters.search or '' }}" class="w-full p-2 border rounded-md">
                <select name="status_filter" class="w-full p-2 border rounded-md bg-white" onchange="this.form.submit()"><option value="">Ù‡Ù…Ù‡ ÙˆØ¶Ø¹ÛŒØª Ù‡Ø§</option><option value="To Do" {% if filters.status == 'To Do' %}selected{% endif %}>Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯Ù‡</option><option value="In Progress" {% if filters.status == 'In Progress' %}selected{% endif %}>Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…</option><option value="Completed" {% if filters.status == 'Completed' %}selected{% endif %}>ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡</option><option value="Failed" {% if filters.status == 'Failed' %}selected{% endif %}>Ù†Ø§Ù…ÙˆÙÙ‚</option></select>
                <select name="level_filter" class="w-full p-2 border rounded-md bg-white" onchange="this.form.submit()"><option value="">Ù‡Ù…Ù‡ Ø³Ø·ÙˆØ­</option>{% for level in TASK_LEVELS %}<option value="{{ level }}" {% if filters.level == level %}selected{% endif %}>{{ level }}</option>{% endfor %}</select>
                <select name="type_filter" class="w-full p-2 border rounded-md bg-white" onchange="this.form.submit()"><option value="">Ù‡Ù…Ù‡ Ø§Ù†ÙˆØ§Ø¹</option>{% for type in TASK_TYPES %}<option value="{{ type }}" {% if filters.type == type %}selected{% endif %}>{{ type }}</option>{% endfor %}</select>
                <select name="section_filter" class="w-full p-2 border rounded-md bg-white" onchange="this.form.submit()"><option value="">Ù‡Ù…Ù‡ Ø¨Ø®Ø´ Ù‡Ø§</option>{% for section in SECTIONS %}<option value="{{ section }}" {% if filters.section == section %}selected{% endif %}>{{ section }}</option>{% endfor %}</select>
                <input type="text" name="man_filter" placeholder=" Ø³Ù¾Ø±Ø¯Ù‡ Ø´Ø¯Ù‡ Ø¨Ù‡ ..." value="{{ filters.man or '' }}" class="w-full p-2 border rounded-md">
                <select name="man_filter" id="filter-selector-create" class="w-full" onchange="this.form.submit()">
                    <option value="">{{ filters.man or 'Ø³Ù¾Ø±Ø¯Ù‡ Ø´Ø¯Ù‡ Ø¨Ù‡...' }}</option>
                    {% for p in users %}
                    <option value="{{ p.username }}">{{ p.username }}</option>
                    {% endfor %}
                </select>
                <input type="text" name="leader_filter" placeholder="Ø±Ù‡Ø¨Ø±" value="{{ filters.leader or '' }}" class="w-full p-2 border rounded-md">
                <select name="leader_filter" id="leader-selector-create" class="w-full" onchange="this.form.submit()">
                    <option value="">{{ filters.leader or 'Ø±Ù‡Ø¨Ø±...' }}</option>
                    {% for p in users %}
                    <option value="{{ p.username }}">{{ p.username }}</option>
                    {% endfor %}
                </select>
                <select name="project_filter" id="proj-selector-create" class="w-full" onchange="this.form.submit()">
                    <option value="">{{ filters.proj or 'Ù¾Ø±ÙˆÚ˜Ù‡...' }}</option>
                    {% for p in projects %}
                    <option value="{{ p.description }}">{{ p.description }} - {{ p.internal_number | truncate(50) }}</option>
                    {% endfor %}
                </select>
                <a href="/dashboard" class="block text-center text-sm text-blue-600 hover:underline mt-2">Ø­Ø°Ù ÙÛŒÙ„ØªØ±Ù‡Ø§</a>
                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md">Ø¬Ø³ØªØ¬Ùˆ</button>
            </div>
        </form>
    </div>

    <div class="lg:col-span-3">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">ğŸ“ ÙˆØ¸Ø§ÛŒÙ Ù…Ø­ÙˆÙ„ Ø´Ø¯Ù‡ Ø¨Ù‡ Ù…Ù†</h2>
        <div class="space-y-4">
            {% for task in my_tasks %}
                <div class="bg-white p-5 rounded-lg shadow-md border-r-4 {% if task.is_failed %}border-red-500{% elif task.status == 'Completed' %}border-green-500{% elif task.status == 'In Progress' %}border-blue-500{% else %}border-gray-400{% endif %}">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-bold text-lg text-gray-900">{{ task.title }}</h3>
                            <p class="text-sm text-gray-600">Ø§Ø²: <strong class="font-medium">{{ task.admin.username }}</strong> | Ù…ÙˆØ¹Ø¯: <strong class="font-medium">{{ task.end_date.strftime('%Y-%m-%d') if task.end_date else 'N/A' }}</strong></p>
                        </div>
                         <div class="text-left flex flex-col items-end gap-2">
                            {% set status_text, status_bg = ('Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯Ù‡', 'bg-gray-100 text-gray-800') %}{% if task.is_failed %}{% set status_text, status_bg = ('Ù†Ø§Ù…ÙˆÙÙ‚', 'bg-red-100 text-red-800') %}{% elif task.status == 'Completed' %}{% set status_text, status_bg = ('ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡', 'bg-green-100 text-green-800') %}{% elif task.status == 'In Progress' %}{% set status_text, status_bg = ('Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…', 'bg-blue-100 text-blue-800') %}{% endif %}
                            <span class="px-3 py-1 text-xs font-semibold rounded-full {{ status_bg }}">{{ status_text }}</span>
                        </div>
                    </div>
                    <div class="mt-4 flex justify-between items-center">
                        <progress class="w-2/3" value="{{ task.success_percent }}" max="100"></progress>
                        <span class="font-bold text-gray-700">{{ "%.0f"|format(task.success_percent|float) }}%</span>
                        <a href="/task/{{ task.id }}" class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold py-2 px-4 rounded-md transition">Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù¾ÛŒØ´Ø±ÙØª</a>
                    </div>
                </div>
            {% else %}
                <p class="text-gray-500 bg-white p-4 rounded-md shadow-sm">Ù‡ÛŒÚ† ÙˆØ¸ÛŒÙÙ‡â€ŒØ§ÛŒ Ø¨Ù‡ Ø´Ù…Ø§ Ù…Ø­ÙˆÙ„ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>
            {% endfor %}
        </div>

        <hr class="my-12 border-t-2 border-gray-200">

        <h2 class="text-3xl font-bold mb-6 text-gray-800">Ú©Ù„ ÙˆØ¸Ø§ÛŒÙ Ø³ÛŒØ³ØªÙ…</h2>
        <div class="space-y-4">
            {% for task in all_system_tasks %}
            <div class="bg-white p-5 rounded-lg shadow-md">
                <div class="flex justify-between items-start">
                    <div>
                        <h4 class="font-bold text-lg text-gray-900 flex items-center gap-2">
                            {{ task.title }}
                            {% if task.is_failed %}<span class="px-2 py-0.5 text-xs font-semibold rounded-full bg-red-100 text-red-800 border border-red-300">Ù†Ø§Ù…ÙˆÙÙ‚</span>{% endif %}
                        </h4>
                        {% if task.project %}<p class="text-xs text-indigo-600 font-semibold">Ù¾Ø±ÙˆÚ˜Ù‡: {{ task.project.internal_number }} - {{ task.project.description | truncate(30) }}</p>{% endif %}
                        <p class="text-sm text-gray-600">Ø¨Ù‡: <strong class="font-medium">{{ task.user.username }} ({{task.user.section}})</strong> | ØªÙˆØ³Ø·: <strong class="font-medium">{{ task.admin.username }}</strong> | Ø±Ù‡Ø¨Ø±: <strong class="font-medium">{{ task.leader.username }}</strong></p>
                        <p class="text-sm text-gray-600">Ø´Ø±ÙˆØ¹: <strong class="font-medium">{{ task.start_date }}</strong> | Ù¾Ø§ÛŒØ§Ù†: <strong class="font-medium">{{ task.end_date }}</strong></p>
                    </div>
                    <div class="text-left flex flex-col items-end gap-2">
                        {% set status_text, status_bg = ('Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯Ù‡', 'bg-gray-100 text-gray-800') %}{% if task.status == 'Completed' %}{% set status_text, status_bg = ('ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡', 'bg-green-100 text-green-800') %}{% elif task.status == 'In Progress' %}{% set status_text, status_bg = ('Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…', 'bg-blue-100 text-blue-800') %}{% endif %}
                        <span class="px-3 py-1 text-xs font-semibold rounded-full {{ status_bg }}">{{ status_text }}</span>
                    </div>
                </div>
                <div class="mt-4 flex justify-end"><a href="/task/{{ task.id }}" class="bg-gray-700 hover:bg-gray-800 text-white text-sm font-bold py-2 px-4 rounded-md transition">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª</a></div>
            </div>
            {% else %}
                <p class="text-gray-500">Ù‡ÛŒÚ† ÙˆØ¸ÛŒÙÙ‡ Ø§ÛŒ Ø¯Ø± Ø³ÛŒØ³ØªÙ… ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>
            {% endfor %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {

    $('#project-selector-create').select2();
    $('#customer-selector-create').select2();
    $('#filter-selector-create').select2();
    $('#leader-selector-create').select2();
    $('#proj-selector-create').select2();
    
    const sectionSelector = document.getElementById('section-selector');
    const userSelector = document.getElementById('user-selector');
    const leaderSelector = document.getElementById('leader-selector');

    // This function now fetches users (including admins) based on the section.
    // Admins will appear regardless of the selected section.
    async function fetchUsersForDropdowns(section) {
        const response = await fetch(`/api/users-by-section?section=${section}`);
        const users = await response.json();
        
        // Populate Assignee dropdown
        userSelector.innerHTML = '<option value="" disabled selected>Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø³Ø¦ÙˆÙ„</option>';
        users.forEach(user => {
            const option = document.createElement('option');
            option.value = user.id;
            option.textContent = user.username;
            userSelector.appendChild(option);
        });
    }

    // This function populates the Leader dropdown with ALL users (admins included)
    async function fetchAllLeaders() {
        const response = await fetch(`/api/users-by-section?section=all`);
        const users = await response.json();

        leaderSelector.innerHTML = '<option value="">Ù‡ÛŒÚ†Ú©Ø¯Ø§Ù…</option>';
        users.forEach(user => {
            const option = document.createElement('option');
            option.value = user.id;
            option.textContent = user.username;
            leaderSelector.appendChild(option);
        });
    }

    sectionSelector.addEventListener('change', function() {
        fetchUsersForDropdowns(this.value);
    });

    // Initial loads
    fetchUsersForDropdowns('all');
    fetchAllLeaders();
});
</script>
{% endblock %}