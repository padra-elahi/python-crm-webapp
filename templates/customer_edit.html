{% extends "base.html" %}
{% block content %}
<div class="max-w-4xl mx-auto bg-white p-6 rounded-lg shadow">
    <h2 class="text-2xl font-bold text-gray-800 mb-6">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ Ù…Ø´ØªØ±ÛŒ</h2>

    <form method="POST" action="/customer/{{ customer.id }}">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input name="name" placeholder="Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ" value="{{ customer.name or '' }}" required class="p-2 border rounded">
            <input name="short_name" placeholder="Ù…Ø®ÙÙ Ù†Ø§Ù…" value="{{ customer.short_name or '' }}" class="p-2 border rounded">

            <select name="product_type" id="product-type" class="p-2 border rounded" required>
                <option value="">Ù†ÙˆØ¹ Ù…Ø­ØµÙˆÙ„</option>
                {% for pt in PRODUCT_TYPES %}
                    <option value="{{ pt }}" {% if customer.product_type == pt %}selected{% endif %}>{{ pt }}</option>
                {% endfor %}
            </select>

            <input name="product_description" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª Ù…Ø­ØµÙˆÙ„" value="{{ customer.product_description or '' }}" class="p-2 border rounded">
            <input name="website_link" placeholder="Ù„ÛŒÙ†Ú© Ø³Ø§ÛŒØª" value="{{ customer.website_link or '' }}" class="p-2 border rounded">

            <select name="registration_status" class="p-2 border rounded" required>
                {% for s in REGISTRATION_STATUSES %}
                    <option value="{{ s }}" {% if customer.registration_status == s %}selected{% endif %}>{{ s }}</option>
                {% endfor %}
            </select>

            <input name="portal_username" placeholder="ÛŒÙˆØ²Ø± Ù¾ÛŒÚ¯ÛŒØ±ÛŒ" value="{{ customer.portal_username or '' }}" class="p-2 border rounded">
            <input name="portal_password" placeholder="Ù¾Ø³ÙˆØ±Ø¯ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ" value="{{ customer.portal_password or '' }}" class="p-2 border rounded">

            <input name="latest_notes" placeholder="Ø¢Ø®Ø±ÛŒÙ† Ø§Ù‚Ø¯Ø§Ù…" value="{{ customer.latest_notes or '' }}" class="p-2 border rounded">
            <input name="portal_url" placeholder="Ù¾Ø±ØªØ§Ù„" value="{{ customer.portal_url or '' }}" class="p-2 border rounded">

            <input name="address1" placeholder="Ø¢Ø¯Ø±Ø³ Û±" value="{{ customer.address1 or '' }}" class="p-2 border rounded">
            <input name="address2" placeholder="Ø¢Ø¯Ø±Ø³ Û²" value="{{ customer.address2 or '' }}" class="p-2 border rounded">
        </div>

        <div id="other-description-container" class="mt-4 {% if customer.product_type != 'Ø³Ø§ÛŒØ±' %}hidden{% endif %}">
            <label class="block text-sm text-gray-700 mb-1">Ø´Ø±Ø­ Ù†ÙˆØ¹ Ù…Ø­ØµÙˆÙ„ (Ø¯Ø± ØµÙˆØ±Øª Ø§Ù†ØªØ®Ø§Ø¨ "Ø³Ø§ÛŒØ±")</label>
            <input name="product_type_description" value="{{ customer.product_type_description or '' }}" class="p-2 border rounded w-full">
        </div>

        <hr class="my-6">

        <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ‘¥ Ø³Ø§Ø®ØªØ§Ø± Ø³Ø§Ø²Ù…Ø§Ù†ÛŒ</h3>
        <div id="units-container" class="space-y-4">
            {% for unit in customer.units %}
            <div class="unit-block p-4 border rounded bg-gray-50" data-index="{{ loop.index0 }}">
                <input type="hidden" name="unit_id_{{ loop.index0 }}" value="{{ unit.id }}">

                <label>ÙˆØ§Ø­Ø¯:</label>
                <input type="text" name="unit_number_{{ loop.index0 }}" value="{{ unit.unit_number }}" required class="p-2 border rounded w-full">

                <label>Ù…Ø¯ÛŒØ±:</label>
                <input type="text" name="manager_{{ loop.index0 }}" value="{{ unit.manager or '' }}" class="p-2 border rounded w-full">

                <label>Ø±Ø¦ÛŒØ³:</label>
                <input type="text" name="boss_{{ loop.index0 }}" value="{{ unit.boss or '' }}" class="p-2 border rounded w-full">

                <label>Ø³Ø±Ù¾Ø±Ø³Øª:</label>
                <input type="text" name="supervisor_{{ loop.index0 }}" value="{{ unit.supervisor or '' }}" class="p-2 border rounded w-full">

                <label>Ú©Ø§Ø±Ø´Ù†Ø§Ø³Ø§Ù† Ø¨Ø§Ø²Ø±Ú¯Ø§Ù†ÛŒ:</label>
                <div class="experts-list space-y-2 mt-2">
                    {% for expert in unit.experts %}
                    <input type="text" name="expert_{{ loop.parent.index0 }}_{{ loop.index0 }}" value="{{ expert.name }}" class="p-2 border rounded w-full">
                    {% endfor %}
                </div>
                <button type="button" class="mt-2 bg-blue-500 text-white px-3 py-1 rounded" onclick="addExpert(this)">â• Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ø´Ù†Ø§Ø³</button>
            </div>
            {% endfor %}
        </div>

        <div class="mt-4">
            <button type="button" class="bg-green-600 text-white px-4 py-2 rounded" onclick="addUnit()">â• Ø§ÙØ²ÙˆØ¯Ù† ÙˆØ§Ø­Ø¯ Ø¬Ø¯ÛŒØ¯</button>
        </div>

        <div class="mt-6 flex justify-end space-x-2">
            <a href="/customers" class="bg-gray-300 text-gray-700 px-4 py-2 rounded">Ø§Ù†ØµØ±Ø§Ù</a>
            <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡</button>
        </div>
    </form>
</div>

<script>
let unitCounter = {{ customer.units|length }};

function addUnit() {
    const container = document.getElementById("units-container");
    const index = unitCounter++;

    const div = document.createElement("div");
    div.className = "unit-block p-4 border rounded bg-gray-50 mt-4";
    div.dataset.index = index;
    div.innerHTML = `
        <label>ÙˆØ§Ø­Ø¯:</label>
        <input type="text" name="unit_number_${index}" class="p-2 border rounded w-full" required>

        <label>Ù…Ø¯ÛŒØ±:</label>
        <input type="text" name="manager_${index}" class="p-2 border rounded w-full">

        <label>Ø±Ø¦ÛŒØ³:</label>
        <input type="text" name="boss_${index}" class="p-2 border rounded w-full">

        <label>Ø³Ø±Ù¾Ø±Ø³Øª:</label>
        <input type="text" name="supervisor_${index}" class="p-2 border rounded w-full">

        <label>Ú©Ø§Ø±Ø´Ù†Ø§Ø³Ø§Ù† Ø¨Ø§Ø²Ø±Ú¯Ø§Ù†ÛŒ:</label>
        <div class="experts-list space-y-2 mt-2"></div>
        <button type="button" class="mt-2 bg-blue-500 text-white px-3 py-1 rounded" onclick="addExpert(this)">â• Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ø´Ù†Ø§Ø³</button>
    `;
    container.appendChild(div);
}

function addExpert(btn) {
    const unitDiv = btn.closest(".unit-block");
    const index = unitDiv.dataset.index;
    const expertContainer = unitDiv.querySelector(".experts-list");

    const expertCount = expertContainer.querySelectorAll("input").length;
    const input = document.createElement("input");
    input.type = "text";
    input.name = `expert_${index}_${expertCount}`;
    input.className = "p-2 border rounded w-full";
    expertContainer.appendChild(input);
}

document.addEventListener("DOMContentLoaded", () => {
    const typeSelect = document.getElementById("product-type");
    const otherContainer = document.getElementById("other-description-container");

    typeSelect.addEventListener("change", () => {
        if (typeSelect.value === "Ø³Ø§ÛŒØ±") {
            otherContainer.classList.remove("hidden");
        } else {
            otherContainer.classList.add("hidden");
            otherContainer.querySelector("input").value = "";
        }
    });
});
</script>
{% endblock %}
