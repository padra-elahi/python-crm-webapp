{% extends "base.html" %}
{% block content %}
<form method="post" action="/task/update/{{ task.id }}">
    <div class="bg-white rounded-lg shadow-xl p-8">
        <div class="flex justify-between items-start mb-4 pb-4 border-b">
            <div>
                <h2 class="text-3xl font-bold text-gray-900 flex items-center gap-3">
                    {{ task.title }}
                    {% if task.is_failed %}<span class="text-base px-3 py-1 font-semibold rounded-full bg-red-100 text-red-800 border border-red-300">ناموفق</span>{% endif %}
                </h2>
                {% if task.project %}<p class="text-sm text-indigo-600 font-semibold mt-1">مربوط به پروژه: <a href="/project/{{ task.project.id }}" class="underline">{{ task.project.internal_number }} - {{ task.project.customer }}</a></p>{% endif %}
            </div>
            <div class="text-left flex flex-col items-end gap-2">
                {% set status_text, status_bg = ('انجام نشده', 'bg-gray-100 text-gray-800') %}{% if task.status == 'Completed' %}{% set status_text, status_bg = ('تکمیل شده', 'bg-green-100 text-green-800') %}{% endif %}{% if task.status == 'In Progress' %}{% set status_text, status_bg = ('در حال انجام', 'bg-blue-100 text-blue-800') %}{% endif %}
                <span class="px-4 py-2 text-sm font-bold rounded-full {{ status_bg }}">{{ status_text }}</span>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mt-6">
            <div class="md:col-span-2 space-y-6">
                <div>
                    <h4 class="font-bold text-gray-700 mb-2">بروزرسانی پیشرفت (توسط شما)</h4>
                    <div class="space-y-3 bg-blue-50 p-4 rounded-md">
                        <div>
                            <label for="success_percent" class="block text-sm font-medium text-gray-700">درصد پیشرفت: <span id="percent-label" class="font-bold">{{ "%.0f"|format(task.success_percent|float) }}%</span></label>
                            <input type="range" id="success_percent" name="success_percent" min="0" max="100" step="5" value="{{ task.success_percent }}" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" oninput="document.getElementById('percent-label').innerText = this.value + '%'">
                        </div>
                        <div>
                             <label for="user_comment" class="block text-sm font-medium text-gray-700">کامنت شما</label>
                            <textarea id="user_comment" name="user_comment" rows="3" class="w-full p-2 border rounded-md" placeholder="آخرین وضعیت را اینجا بنویسید...">{{ task.user_comment or "" }}</textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div class="md:col-span-1 space-y-6">
                <div>
                    <h4 class="font-bold text-gray-700 mb-2">کامنت مدیر</h4>
                    <textarea name="admin_comment" rows="3" class="w-full p-2 border rounded-md" placeholder="دستورالعمل یا بازخورد..." {% if user.role != 'admin' %}readonly{% endif %}>{{ task.admin_comment or "" }}</textarea>
                </div>
            </div>
        </div>
        {% if user.role in ['admin', 'boss'] %}
        <div class="border-t pt-6 mt-6">
            <h4 class="font-bold text-red-600 mb-2">کنترل های ادمین</h4>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 bg-red-50 p-4 rounded-md">
                <div>
                    <label class="text-sm">پروژه مرتبط:</label>
                    <select name="project_id" id="project-selector-edit" class="w-full">
                        <option value="">هیچکدام</option>
                        {% for p in projects %}
                        <option value="{{ p.id }}" {% if task.project_id == p.id %}selected{% endif %}>
                            {{ p.internal_number }} - {{ p.description | truncate(50) }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div><label class="text-sm">تغییر مسئول:</label><select name="assigned_to" class="w-full p-2 border rounded-md bg-white">{% for u in users %}<option value="{{ u.id }}" {% if u.id == task.assigned_to %}selected{% endif %}>{{ u.username }}</option>{% endfor %}</select></div>
                <div><label class="text-sm">تغییر رهبر:</label><select name="leader_id" class="w-full p-2 border rounded-md bg-white"><option value="">هیچکدام</option>{% for u in users %}<option value="{{ u.id }}" {% if u.id == task.leader_id %}selected{% endif %}>{{ u.username }}</option>{% endfor %}</select></div>
                <div><label class="text-sm">تغییر اهمیت:</label><select name="level" class="w-full p-2 border rounded-md bg-white">{% for level in TASK_LEVELS %}<option value="{{ level }}" {% if level == task.level %}selected{% endif %}>{{ level }}</option>{% endfor %}</select></div>
                <div><label class="text-sm">تغییر نوع:</label><select name="task_type" class="w-full p-2 border rounded-md bg-white">{% for type in TASK_TYPES %}<option value="{{ type }}" {% if type == task.task_type %}selected{% endif %}>{{ type }}</option>{% endfor %}</select></div>
                <div><label class="text-sm">تغییر تاریخ پایان:</label><input name="end_date" type="date" class="w-full p-2 border rounded-md" value="{{ task.end_date.strftime('%Y-%m-%d') if task.end_date else '' }}"></div>
                <div><label class="text-sm">تاریخ پیگیری:</label><input type="date" name="follow_up_date" value="{{ task.follow_up_date.strftime('%Y-%m-%d') if task.follow_up_date else '' }}" class="w-full p-2 border rounded-md"></div>
                <div class="md:col-span-2"><label class="text-sm">پیام پیگیری:</label><input type="text" name="follow_up_message" value="{{ task.follow_up_message or '' }}" class="w-full p-2 border rounded-md"></div>
            </div>
        </div>
        {% endif %}
        <div class="border-t mt-8 pt-6 flex justify-between items-center">
             <a href="/dashboard" class="text-sm font-medium text-gray-600 hover:text-gray-800">→ بازگشت به داشبورد</a>
            <div>
                 {% if user.role in ['admin', 'boss'] %}<button type="submit" formaction="/task/delete/{{ task.id }}" formmethod="post" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md transition ml-2" onclick="return confirm('آیا از حذف این وظیفه اطمینان دارید؟');">حذف وظیفه</button>{% endif %}
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition">ذخیره تغییرات</button>
            </div>
        </div>
    </div>
</form>
<script>
document.addEventListener('DOMContentLoaded', function() {
    $('#project-selector-edit').select2();
});
</script>
{% endblock %}